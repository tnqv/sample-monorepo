# ===========================================
# Terraform Infrastructure CI/CD
# ===========================================
# Provisions infrastructure for staging and production using workspaces
# - PR: Plan only
# - Push to main: Apply to staging
# - Manual: Apply to production (with approval)

name: "Terraform"

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply

env:
  TF_VERSION: '1.13.1'
  AWS_REGION: us-east-1
  TF_WORKING_DIR: terraform

concurrency:
  group: terraform-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  # ===========================================
  # Terraform Plan (PR)
  # ===========================================
  plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    strategy:
      matrix:
        workspace: [staging, prod]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Dummy step for testing - uncomment AWS config for real deployment
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select/Create Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform workspace select ${{ matrix.workspace }} || terraform workspace new ${{ matrix.workspace }}

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var="environment=${{ matrix.workspace }}" \
            -var-file="environments/${{ matrix.workspace }}.tfvars" \
            -no-color \
            -out=tfplan-${{ matrix.workspace }} 2>&1 | tee plan-output.txt
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan-output.txt', 'utf8');
            const workspace = '${{ matrix.workspace }}';
            
            const output = `### Terraform Plan - \`${workspace}\`
            
            <details>
            <summary>Show Plan</summary>
            
            \`\`\`
            ${plan.substring(0, 65000)}
            \`\`\`
            
            </details>
            
            *Triggered by @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  # ===========================================
  # Deploy to Staging (Push to main)
  # ===========================================
  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Dummy step for testing
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select/Create Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform workspace select staging || terraform workspace new staging

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var="environment=staging" \
            -var-file="environments/staging.tfvars" \
            -out=tfplan

      # Dummy apply for testing
      - name: Terraform Apply (dummy)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "Would run: terraform apply -auto-approve tfplan"
          echo "Staging infrastructure deployed!"

      # Real apply (uncomment when ready)
      # - name: Terraform Apply
      #   working-directory: ${{ env.TF_WORKING_DIR }}
      #   run: terraform apply -auto-approve tfplan

      - name: Staging Summary
        run: |
          echo "## ðŸŸ¡ Staging Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Deploy to Production (Manual with Approval)
  # ===========================================
  deploy-prod:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Dummy step for testing
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select/Create Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform workspace select prod || terraform workspace new prod

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var="environment=prod" \
            -var-file="environments/prod.tfvars" \
            -out=tfplan

      - name: Terraform Apply or Plan Only
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            echo "Would run: terraform apply -auto-approve tfplan"
            echo "Production infrastructure deployed!"
            # terraform apply -auto-approve tfplan
          else
            echo "Plan completed. Run with 'apply' action to deploy."
          fi

      - name: Production Summary
        if: github.event.inputs.action == 'apply'
        run: |
          echo "## ðŸŸ¢ Production Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | production |" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | prod |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Manual Staging Deploy (workflow_dispatch)
  # ===========================================
  manual-staging:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select/Create Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform workspace select staging || terraform workspace new staging

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var="environment=staging" \
            -var-file="environments/staging.tfvars" \
            -out=tfplan

      - name: Terraform Apply or Plan Only
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            echo "Would run: terraform apply -auto-approve tfplan"
            echo "Staging infrastructure deployed!"
            # terraform apply -auto-approve tfplan
          else
            echo "Plan completed. Run with 'apply' action to deploy."
          fi

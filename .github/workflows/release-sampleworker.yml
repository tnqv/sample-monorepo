# ===========================================
# Release Pipeline - sampleworker
# ===========================================
# Releases sampleworker service: staging â†’ approval â†’ prod

name: "Release: sampleworker"

on:
  push:
    branches:
      - release
    paths:
      - 'cmd/sampleworker/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:
    inputs:
      skip_staging:
        description: 'Skip staging (deploy directly to prod)'
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: email-platform
  SERVICE_NAME: sampleworker

concurrency:
  group: release-sampleworker
  cancel-in-progress: false

jobs:
  # ===========================================
  # Build Image
  # ===========================================
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_uri_staging: ${{ steps.meta.outputs.image_uri_staging }}
      image_uri_prod: ${{ steps.meta.outputs.image_uri_prod }}

    steps:
      - uses: actions/checkout@v4

      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2

      # - name: Generate image metadata
      #   id: meta
      #   run: |
      #     SHORT_SHA=$(git rev-parse --short HEAD)
      #     TIMESTAMP=$(date +%Y%m%d%H%M%S)
      #     IMAGE_TAG="${{ env.SERVICE_NAME }}-${SHORT_SHA}-${TIMESTAMP}"
          
      #     echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
      #     echo "image_uri_staging=${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}/staging/${{ env.SERVICE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT
      #     echo "image_uri_prod=${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_NAME }}/prod/${{ env.SERVICE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3

      # - name: Build and push image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: cmd/${{ env.SERVICE_NAME }}/Dockerfile
      #     push: true
      #     tags: |
      #       ${{ steps.meta.outputs.image_uri_staging }}
      #       ${{ steps.meta.outputs.image_uri_prod }}
      #     build-args: |
      #       VERSION=${{ steps.meta.outputs.image_tag }}
      #       BUILD_TIME=${{ github.event.head_commit.timestamp }}
      #       GIT_COMMIT=${{ github.sha }}
      #     cache-from: type=gha,scope=${{ env.SERVICE_NAME }}
      #     cache-to: type=gha,mode=max,scope=${{ env.SERVICE_NAME }}

      - name: Build Image
        run: |
          echo "Building image"
          echo "Configuring AWS credentials"
          echo "Logging in to ECR"
          echo "Generating image metadata"
          echo "Setting up Docker Buildx"
          echo "Building and pushing image"
          echo "Image built successfully"

      - name: Build summary
        run: |
          echo "## ðŸ”¨ Build Complete - ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ steps.meta.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Deploy to Staging
  # ===========================================
  deploy-staging:
    needs: build
    if: ${{ !inputs.skip_staging }}
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      id-token: write
      contents: read

    steps:
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      # - name: Get current task definition
      #   run: |
      #     aws ecs describe-task-definition \
      #       --task-definition ${{ env.PROJECT_NAME }}-staging-${{ env.SERVICE_NAME }} \
      #       --query 'taskDefinition' \
      #       > task-definition.json

      # - name: Update task definition
      #   id: render-task-def
      #   uses: aws-actions/amazon-ecs-render-task-definition@v1
      #   with:
      #     task-definition: task-definition.json
      #     container-name: ${{ env.SERVICE_NAME }}
      #     image: ${{ needs.build.outputs.image_uri_staging }}

      # - name: Deploy to ECS Staging
      #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      #   with:
      #     task-definition: ${{ steps.render-task-def.outputs.task-definition }}
      #     service: ${{ env.PROJECT_NAME }}-staging-${{ env.SERVICE_NAME }}
      #     cluster: ${{ env.PROJECT_NAME }}-staging
      #     wait-for-service-stability: true
      #     wait-for-minutes: 10
      - name: Deploy to ECS Staging
        run: |
          echo "Configuring AWS credentials"
          echo "Getting current task definition"
          echo "Deploying to ECS Staging"

      - name: Staging summary
        run: |
          echo "## ðŸŸ¡ Staging Deployed - ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Staging deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ **Waiting for production approval...**" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Deploy to Production (Approval Required)
  # ===========================================
  deploy-production:
    needs: [build, deploy-staging]
    if: always() && needs.build.result == 'success' && (needs.deploy-staging.result == 'success' || needs.deploy-staging.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}

      # - name: Get current task definition
      #   run: |
      #     aws ecs describe-task-definition \
      #       --task-definition ${{ env.PROJECT_NAME }}-prod-${{ env.SERVICE_NAME }} \
      #       --query 'taskDefinition' \
      #       > task-definition.json

      # - name: Update task definition
      #   id: render-task-def
      #   uses: aws-actions/amazon-ecs-render-task-definition@v1
      #   with:
      #     task-definition: task-definition.json
      #     container-name: ${{ env.SERVICE_NAME }}
      #     image: ${{ needs.build.outputs.image_uri_prod }}

      # - name: Deploy to ECS Production
      #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      #   with:
      #     task-definition: ${{ steps.render-task-def.outputs.task-definition }}
      #     service: ${{ env.PROJECT_NAME }}-prod-${{ env.SERVICE_NAME }}
      #     cluster: ${{ env.PROJECT_NAME }}-prod
      #     wait-for-service-stability: true
      #     wait-for-minutes: 15
      - name: Deploy to ECS Production
        run: |
          echo "Configuring AWS credentials"
          echo "Getting current task definition"
          echo "Deploying to ECS Production"

      - name: Production summary
        run: |
          echo "## ðŸŸ¢ Production Deployed - ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | **${{ env.SERVICE_NAME }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.build.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
